# oc-bgp-neighbors_jnxBgpM2PeerTable.yml
# SNMP: BGP4-V2-MIB-JUNIPER::jnxBgpM2PeerTable
# OC: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/state
# Kentik-path: /protocols/bgp/neighbors
#
# Profile intents to collect metadata and metrics about device interface from SNMP BGP4-V2-MIB-JUNIPER
# Trying to normalize metrics to openconfig-bgp model as much as possible

---

extends:
  - oc-bgp-global.yml

metrics:

# Description: BGP neighbors metadata and status
# SNMP: BGP4-V2-MIB-JUNIPER::jnxBgpM2PeerTable
# OC: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/state
# Kentik-path: /protocols/bgp/neighbors

  - MIB: /protocols   # openconfig-bgp
    table:
      OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1    # BGP4-V2-MIB-JUNIPER::jnxBgpM2PeerTable
      name: bgp/neighbors # /protocols/bgp/neighbors
      # oc-path: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/state

    symbols:

      - tag: bgp:session-state
        OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.2
        name: jnxBgpM2PeerState
        enum:
          idle: 1
          connect: 2
          active: 3
          opensent: 4
          openconfirm: 5
          established: 6

      - tag: bgp:enabled
        OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.3
        name: jnxBgpM2PeerStatus
        
      - tag: bgp:in-updates
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.1.1.1
        name: jnxBgpM2PeerInUpdates
        
      - tag: bgp:out-updates
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.1.1.2
        name: jnxBgpM2PeerOutUpdates
        
      - tag: bgp:in-messages
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.1.1.3
        name: jnxBgpM2PeerInTotalMessages
        
      - tag: bgp:out-messages
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.1.1.4
        name: jnxBgpM2PeerOutTotalMessages
        
      - tag: bgp:established-transitions
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.1.1.5
        name: jnxBgpM2PeerFsmEstablishedTrans

      - tag: bgp:last-established
        OID: .1.3.6.1.4.1.2636.5.1.1.2.4.1.1.1
        name: jnxBgpM2PeerFsmEstablishedTime


    metric_tags:

      - tag: bgp:neighbor-address
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.1
          name: jnxBgpM2PeerIdentifier

      - tag: bgp:local-address-type
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.6
          name: jnxBgpM2PeerLocalAddrType
          enum:
            ipv4: 1
            ipv6: 2

      - tag: bgp:local-address
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.7
          name: jnxBgpM2PeerLocalAddr
          conversion: hextoip

      - tag: bgp:local-port
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.8
          name: jnxBgpM2PeerLocalPort

      - tag: bgp:local-as
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.9
          name: jnxBgpM2PeerLocalAs

      - tag: bgp:remote-address-type
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.10
          name: jnxBgpM2PeerRemoteAddrType
          enum:
            ipv4: 1
            ipv6: 2

      - tag: bgp:remote-address
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.11
          name: jnxBgpM2PeerRemoteAddr
          conversion: hextoip

      - tag: bgp:remote-port
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.12
          name: jnxBgpM2PeerRemotePort

      - tag: bgp:peer-as
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.13
          name: jnxBgpM2PeerRemoteAs

      # Not in the OC - this is used to correlate the prefix counters in the different table        
      - tag: bgp:peer-index
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14
          name: jnxBgpM2PeerIndex

      - tag: bgp:network-instance
        column:
          OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1.1.15
          name: jnxBgpM2PeerRoutingInstance



# Description: BGP prefixes per neighbor
# SNMP: BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixCountersTable
# OC: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/afi-safis/afi-safi/state/prefixes
# Kentik-path: /protocols/bgp/neighbors/prefixes

  - MIB: /protocols
    table:
      OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1    # BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixCountersTable
      name: bgp/neighbors/prefixes # /protocols/bgp/neighbors/prefixes

    symbols:

      - tag: bgp:received-pre-policy    # in-prefixes
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.7
        name: jnxBgpM2PrefixInPrefixes
        
      - tag: bgp:received     # in-prefixes-accepted
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8
        name: jnxBgpM2PrefixInPrefixesAccepted
        
      - tag: bgp:rejected    # in-prefixes-rejected
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9
        name: jnxBgpM2PrefixInPrefixesRejected
        
      - tag: bgp:sent    # out-prefixes
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10
        name: jnxBgpM2PrefixOutPrefixes
        
      - tag: bgp:installed    # in-prefixes-active
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.11
        name: jnxBgpM2PrefixInPreixesActive
        

    metric_tags:

    # OC: afi-safi-name
    # https://github.com/openconfig/public/blob/master/release/models/bgp/openconfig-bgp-types.yang

    - tag: bgp:afi
      column:
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.1
        name: jnxBgpM2PrefixCountersAfi
        enum:
          UNKNOWN: 0
          IPV4: 1
          IPV6: 2
          IPV4Z: 3
          IPV6Z: 4
          DNS: 16
          L2VPN: 25
          LINKSTATE: 16388

    - tag: bgp:safi
      column:
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.2
        name: jnxBgpM2PrefixCountersSafi
        enum:
          UNICAST: 1
          MULTICAST: 2
          LABELED_UNICAST: 4
          L3VPN: 128
          MCAST-VPN: 129
          FLOWSPEC: 133
          MS-PW: 6
          VPLS: 65
          EVPN: 70
          LINKSTATE: 71
          VPN: 72
        script: |
          def main(n):
            if n["bgp:afi"] not in "":
              new_index_list = n.Index.split(".", 1)
              n.Index = new_index_list[0]
            return None