# cisco-oc-bgp.yml
# SNMP: CISCO-BGP4-MIB::cbgpPeer2Table, CISCO-BGP4-MIB::cbgpPeer2AddrFamilyPrefixTable
# OC: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/state
# Kentik-path: /protocols/bgp/neighbors
#
# Profile intents to collect metadata and metrics about device interface from SNMP BGP4-V2-MIB-JUNIPER
# Trying to normalize metrics to openconfig-bgp model as much as possible

---

extends:
  - oc-bgp-global.yml

metrics:

# Description: BGP neighbors metadata and status
# SNMP: CISCO-BGP4-MIB::cbgpPeer2Table
# OC: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/state
# Kentik-path: /protocols/bgp/neighbors

  - MIB: /protocols
    table:
      OID: .1.3.6.1.4.1.9.9.187.1.2.5
      name: bgp/neighbors # /protocols/bgp/neighbors
      # oc-path: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/state

    symbols:

      - tag: bgp:session-state
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.3
        name: cbgpPeer2State
        enum:
          idle: 1
          connect: 2
          active: 3
          opensent: 4
          openconfirm: 5
          established: 6
       
      - tag: bgp:in-updates
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.13
        name: cbgpPeer2InUpdates
        
      - tag: bgp:out-updates
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.14
        name: cbgpPeer2OutUpdates
        
      - tag: bgp:in-messages
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.15
        name: cbgpPeer2InTotalMessages
        
      - tag: bgp:out-messages
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.16
        name: cbgpPeer2OutTotalMessages
        
      - tag: bgp:established-transitions
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.18
        name: cbgpPeer2FsmEstablishedTransitions

      - tag: bgp:last-established
        OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.19
        name: cbgpPeer2FsmEstablishedTime


    metric_tags:

      - tag: bgp:enabled
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.4
          name: cbgpPeer2AdminStatus
          enum:
            "false": 1
            "true": 2

      - tag: bgp:neighbor-address
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.12
          name: cbgpPeer2RemoteIdentifier

      - tag: bgp:local-address-type
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.4
          name: 
          enum:
            ipv4: 1
            ipv6: 2

      - tag: bgp:local-address
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.6
          name: cbgpPeer2LocalAddr
          conversion: hextoip

      - tag: bgp:local-port
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.7
          name: cbgpPeer2LocalPort

      - tag: bgp:local-as
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.8
          name: cbgpPeer2LocalAs

      # Embedded into the index, need to extract using script
      # - tag: bgp:remote-address-type
      #   column:
      #     OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.4
      #     name: 
      #     enum:
      #       ipv4: 1
      #       ipv6: 2

      - tag: bgp:remote-address
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.2
          name: cbgpPeer2RemoteAddr
          conversion: hextoip

      - tag: bgp:remote-port
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.10
          name: cbgpPeer2RemotePort

      - tag: bgp:peer-as
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.11
          name: cbgpPeer2RemoteAs

      # Not in the OC - this is used to correlate the prefix counters in the different table        
      - tag: bgp:prefix-table-index
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.4
          name: 

      - tag: bgp:network-instance
        column:
          OID: .1.3.6.1.4.1.9.9.187.1.2.5.1.4
          name: 



# Description: BGP prefixes per neighbor
# SNMP: BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixCountersTable
# OC: /network-instances/network-instance/protocols/protocol/bgp/neighbors/neighbor/afi-safis/afi-safi/state/prefixes
# Kentik-path: /protocols/bgp/neighbors/prefixes

  - MIB: /protocols
    table:
      OID: .1.3.6.1.4.1.2636.5.1.1.2.1.1    # BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixCountersTable
      name: bgp/neighbors/prefixes # /protocols/bgp/neighbors/prefixes

    symbols:

      - tag: bgp:received-pre-policy    # in-prefixes
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.7
        name: jnxBgpM2PrefixInPrefixes
        
      - tag: bgp:received     # in-prefixes-accepted
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8
        name: jnxBgpM2PrefixInPrefixesAccepted
        
      - tag: bgp:rejected    # in-prefixes-rejected
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9
        name: jnxBgpM2PrefixInPrefixesRejected
        
      - tag: bgp:sent    # out-prefixes
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10
        name: jnxBgpM2PrefixOutPrefixes
        
      - tag: bgp:installed    # in-prefixes-active
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.11
        name: jnxBgpM2PrefixInPreixesActive
        

    metric_tags:

    # OC: afi-safi-name
    # https://github.com/openconfig/public/blob/master/release/models/bgp/openconfig-bgp-types.yang

    - tag: bgp:afi
      column:
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.1
        name: jnxBgpM2PrefixCountersAfi
        enum:
          UNKNOWN: 0
          IPV4: 1
          IPV6: 2
          IPV4Z: 3
          IPV6Z: 4
          DNS: 16
          L2VPN: 25
          LINKSTATE: 16388

    - tag: bgp:safi
      column:
        OID: .1.3.6.1.4.1.2636.5.1.1.2.6.2.1.2
        name: jnxBgpM2PrefixCountersSafi
        enum:
          UNICAST: 1
          MULTICAST: 2
          LABELED_UNICAST: 4
          L3VPN: 128
          MCAST-VPN: 129
          FLOWSPEC: 133
          MS-PW: 6
          VPLS: 65
          EVPN: 70
          LINKSTATE: 71
          VPN: 72
        script: |
          def main(n):
            if n["bgp:afi"] not in "":
              new_index_list = n.Index.split(".", 1)
              n.Index = new_index_list[0]
            return None